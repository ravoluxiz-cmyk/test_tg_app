# Интеграция BBP Pairings (Dutch/Burstein)

BBP Pairings — внешний движок швейцарской системы. Он поддерживает правила ФИДЕ (Dutch) и вариант Burstein и использует расширение TRF(bx) для явного задания системы очков.

## Требования

- Установите бинарь BBP Pairings.
- Убедитесь, что бинарь доступен в PATH или укажите путь в переменной окружения `BBP_PAIRINGS_BIN`. Поддерживаются абсолютные и относительные пути.
- Авто‑обнаружение: на macOS arm64 по умолчанию пробуем `frontend/bin/bbp/bbpPairings-macos-arm64`, если переменная не задана.
- Примеры:
  ```bash
  BBP_PAIRINGS_BIN=/opt/bbpPairings/bbpPairings
  BBP_PAIRINGS_BIN=./bin/bbp-mock.js    # включить mock‑движок для локальных тестов
  ```

## Как это работает в проекте

- Маршрут `POST /api/tournaments/[id]/tours/[tourId]/pairings`:
  - Генерация пар выполняется исключительно через BBP Pairings.
  - При недоступности BBP или пустом результате API возвращает 502 (Bad Gateway); пары не будут созданы.
- Формат турнира определяет вариант BBP:
  - `swiss_bbp_dutch` → передаём флаг `--dutch`
  - `swiss_bbp_burstein` → передаём флаг `--burstein`
- Минимальный TRF(bx), совместимый с BBP:
  - `XXC white1` — стартовое правило цвета фигур
  - `012 <title> <id?>`, `022 Online`, `032 YYYY-MM-DD` — базовые заголовки
  - `XXR <rounds>` — ожидаемое число туров
  - Линии системы очков: `BBW <win>`, `BBL <loss>`, `BBD <draw>`, `BBU <bye>`
  - Блок игроков: строки `001` фиксированной длины (ID, рейтинг, суммарные очки)
- Суммарные очки игрока для TRF(bx) теперь вычисляются по результатам предыдущих туров из базы данных.

## Диагностика

- Логи имеют метку `[BBP]`.
- Временные файлы: `/tmp/bbp-<tournamentId>-<roundId>/` — `trn.trfx`, `outfile.txt`, `checklist.txt`.
- При ошибке исполнения мы логируем `workDir`, пути к файлам, а также первые 500 символов `stderr`/`stdout`.

## Известные ограничения

- Генерация полноценного TRF (поколоночные записи туров и специальные коды несыгранных партий) будет расширена позже; сейчас передаём только суммарные очки.
- Парсинг `outfile.txt` эвристический. Пришлите пример реального вывода — адаптируем строгий парсер.

## Быстрый старт

1. В `frontend/.env.local` задайте один из вариантов:
   ```bash
   # использовать реальный бинарь
   BBP_PAIRINGS_BIN=/полный/путь/к/bbpPairings
   # или включить mock-движок для smoke-тестов
   BBP_PAIRINGS_BIN=./bin/bbp-mock.js
   ```
2. Перезапустите dev-сервер.
3. Создайте турнир с форматом `swiss_bbp_dutch` или `swiss_bbp_burstein`.
4. Создайте тур и нажмите «Сгенерировать пары». При успешной настройки — пары появятся с `source='bbp'`.