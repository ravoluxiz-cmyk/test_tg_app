# Тестовый сценарий для системы турниров

## Исправленные проблемы

### 1. Ошибка "Forbidden" при добавлении участников

**Проблема:** API `/api/participants/add` не проверял авторизацию пользователя.

**Решение:** Добавлена проверка авторизации через `requireAdmin()`:

```typescript
const adminUser = await requireAdmin(request.headers)
if (!adminUser) {
  return NextResponse.json({ error: "Forbidden - Admin access required" }, { status: 403 })
}
```

**Тестирование:**
1. Пользователь без прав администратора получает ошибку 403
2. Администратор может успешно добавлять участников
3. Добавлена обработка ошибок с понятными сообщениями

### 2. Улучшенный поиск участников

**Новый функционал:**
- Поиск по имени и фамилии (например: "Чеслав Царюк")
- Поиск по username (например: "@dprilepsky")
- Выпадающее меню с подсказками
- Отображение рейтинга в результатах поиска

**API Endpoint:** `/api/users/search?q=запрос`

**Примеры использования:**
```bash
# Поиск по имени
curl "https://rep-chess-tg-app.vercel.app/api/users/search?q=Чеслав"

# Поиск по фамилии  
curl "https://rep-chess-tg-app.vercel.app/api/users/search?q=Царюк"

# Поиск по username
curl "https://rep-chess-tg-app.vercel.app/api/users/search?q=dprilepsky"
```

**Ответ API:**
```json
{
  "users": [
    {
      "id": 251,
      "telegram_id": 186796247,
      "username": "dprilepsky",
      "first_name": "Dmitry", 
      "last_name": "Prilepsky",
      "rating": 800
    }
  ]
}
```

## Тестовый сценарий

### Шаг 1: Авторизация администратора
1. Открыть Telegram Web App через бота @RepChessKRD_bot
2. Убедиться, что пользователь имеет роль 'admin' в базе данных
3. Перейти в раздел администрирования турниров

### Шаг 2: Добавление участников
1. Перейти на страницу добавления участников турнира
2. В поле поиска ввести:
   - Имя: "Чеслав"
   - Фамилию: "Царюк" 
   - Username: "@dprilepsky"
3. Выбрать пользователя из выпадающего списка
4. Ввести уникальный никнейм для турнира
5. Нажать "Добавить участника"

### Шаг 3: Проверка ошибок
1. Попробовать добавить участника без авторизации - должна появиться ошибка "Forbidden"
2. Попробовать добавить участника без выбора пользователя - должно появиться сообщение об ошибке
3. Попробовать добавить участника с пустым никнеймом - должно появиться сообщение об ошибке

### Шаг 4: Проверка поиска
1. Ввести менее 2 символов - поиск не должен выполняться
2. Ввести несуществующее имя - должно показаться "Ничего не найдено"
3. Проверить, что в результатах отображаются:
   - Имя и фамилия пользователя
   - Username
   - Рейтинг

## Валидация данных

### Требования к никнейму:
- Обязательное поле
- Уникальность в рамках турнира
- Минимум 1 символ
- Максимум 50 символов

### Требования к поиску:
- Минимум 2 символа для поиска
- Поиск без учета регистра
- Поиск по подстроке

## Обработка ошибок

### Клиентская часть:
- Понятные сообщения об ошибках на русском языке
- Визуальная индикация загрузки
- Обработка сетевых ошибок

### Серверная часть:
- Проверка авторизации (403 Forbidden)
- Проверка входных данных (400 Bad Request)
- Проверка существования турнира и пользователя
- Обработка дублирования никнеймов

## Документация для разработчиков

### Используемые технологии:
- Next.js 15.5.4 с App Router
- TypeScript
- Supabase для хранения данных
- Telegram Web App API

### Ключевые компоненты:
1. **API `/api/users/search`** - поиск пользователей
2. **API `/api/participants/add`** - добавление участников  
3. **Компонент `TournamentParticipantsPage`** - UI для управления участниками

### Безопасность:
- Проверка авторизации на всех административных операциях
- Валидация входных данных
- Защита от SQL инъекций через Supabase
- Проверка прав доступа к турнирам